import { useState } from 'react';
import { Icon } from '../ui';
import { DestinationCard } from './DestinationCard';
import { COUNTRIES, DESTINATIONS } from '../../data/config';
import { DESTINATION_INFO } from '../../data/destinations';
import { getAllPOICount } from '../../data/poi';
import { PRECONISATIONS } from '../../data/preconisations';

const TRANSPORT_TYPES = [
  { id: 'avion', label: 'Avion', icon: 'plane' },
  { id: 'bus', label: 'Bus', icon: 'bus' },
  { id: 'train', label: 'Train', icon: 'train' },
  { id: 'ferry', label: 'Ferry', icon: 'ship' },
  { id: 'bateau', label: 'Bateau rapide', icon: 'ship' },
  { id: 'van', label: 'Van/Minibus', icon: 'bus' },
  { id: 'voiture', label: 'Voiture', icon: 'car' },
  { id: 'scooter', label: 'Scooter', icon: 'bike' },
];

// Helper pour trouver le pays d'une destination
const getCountryForDestination = (destId) => {
  for (const [countryId, destIds] of Object.entries(DESTINATIONS)) {
    if (destIds.includes(destId)) {
      return countryId;
    }
  }
  return null;
};

// Helper pour obtenir les infos pays
const getCountryInfo = (countryId) => {
  return COUNTRIES.find(c => c.id === countryId);
};

// Couleurs par pays
const COUNTRY_COLORS = {
  philippines: '#3b82f6',
  thailande: '#ef4444',
  vietnam: '#eab308',
  bali: '#22c55e'
};

export function ItineraireBuilder({ 
  etapes, 
  onAddEtape, 
  onUpdateEtape, 
  onRemoveEtape,
  onReorderEtapes 
}) {
  const [showAddModal, setShowAddModal] = useState(false);
  const [draggedIndex, setDraggedIndex] = useState(null);
  const [selectedCountry, setSelectedCountry] = useState('all');

  // Destinations d√©j√† ajout√©es
  const addedDestinations = etapes.map(e => e.destination_id);

  // Toutes les destinations disponibles (non ajout√©es)
  const getAllDestinations = () => {
    const allDests = [];
    Object.entries(DESTINATIONS).forEach(([countryId, destIds]) => {
      destIds.forEach(destId => {
        if (!addedDestinations.includes(destId)) {
          const info = DESTINATION_INFO[destId];
          if (info) {
            allDests.push({
              id: destId,
              countryId,
              name: info.name,
              image: info.image,
              days: info.days
            });
          }
        }
      });
    });
    return allDests;
  };

  const availableDestinations = getAllDestinations().filter(
    d => selectedCountry === 'all' || d.countryId === selectedCountry
  );

  // Drag & Drop handlers
  const handleDragStart = (e, index) => {
    setDraggedIndex(index);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e, index) => {
    e.preventDefault();
    if (draggedIndex === null || draggedIndex === index) return;
    
    const newEtapes = [...etapes];
    const draggedItem = newEtapes[draggedIndex];
    newEtapes.splice(draggedIndex, 1);
    newEtapes.splice(index, 0, draggedItem);
    
    setDraggedIndex(index);
    onReorderEtapes(newEtapes);
  };

  const handleDragEnd = () => {
    setDraggedIndex(null);
  };

  // Stats
  const totalNuits = etapes.reduce((sum, e) => sum + e.nb_nuits, 0);
  const totalHebergement = etapes.reduce((sum, e) => sum + (e.hebergement_prix * e.nb_nuits), 0);
  const totalTransport = etapes.reduce((sum, e) => sum + (e.transport_cout || 0), 0);

  return (
    <div style={{ padding: 24 }}>
      {/* Stats rapides */}
      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: 'repeat(4, 1fr)', 
        gap: 16, 
        marginBottom: 24 
      }}>
        <div style={{ 
          backgroundColor: 'white', 
          padding: 16, 
          borderRadius: 12,
          border: '1px solid #e5e7eb'
        }}>
          <div style={{ fontSize: 13, color: '#6b7280', marginBottom: 4 }}>Destinations</div>
          <div style={{ fontSize: 24, fontWeight: 600, color: '#111827' }}>{etapes.length}</div>
        </div>
        <div style={{ 
          backgroundColor: 'white', 
          padding: 16, 
          borderRadius: 12,
          border: '1px solid #e5e7eb'
        }}>
          <div style={{ fontSize: 13, color: '#6b7280', marginBottom: 4 }}>Nuits</div>
          <div style={{ fontSize: 24, fontWeight: 600, color: '#111827' }}>{totalNuits}</div>
        </div>
        <div style={{ 
          backgroundColor: 'white', 
          padding: 16, 
          borderRadius: 12,
          border: '1px solid #e5e7eb'
        }}>
          <div style={{ fontSize: 13, color: '#6b7280', marginBottom: 4 }}>H√©bergements</div>
          <div style={{ fontSize: 24, fontWeight: 600, color: '#6366f1' }}>{totalHebergement.toLocaleString()}‚Ç¨</div>
        </div>
        <div style={{ 
          backgroundColor: 'white', 
          padding: 16, 
          borderRadius: 12,
          border: '1px solid #e5e7eb'
        }}>
          <div style={{ fontSize: 13, color: '#6b7280', marginBottom: 4 }}>Transports</div>
          <div style={{ fontSize: 24, fontWeight: 600, color: '#6366f1' }}>{totalTransport.toLocaleString()}‚Ç¨</div>
        </div>
      </div>

      {/* Bouton Ajouter */}
      <button
        onClick={() => setShowAddModal(true)}
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: 8,
          padding: '12px 20px',
          backgroundColor: '#6366f1',
          color: 'white',
          border: 'none',
          borderRadius: 10,
          fontSize: 14,
          fontWeight: 500,
          cursor: 'pointer',
          marginBottom: 24
        }}
      >
        <Icon name="plus" size={18} />
        Ajouter une destination
      </button>

      {/* Liste des √©tapes */}
      {etapes.length === 0 ? (
        <div style={{ 
          textAlign: 'center', 
          padding: '60px 20px',
          backgroundColor: 'white',
          borderRadius: 12,
          border: '2px dashed #e5e7eb'
        }}>
          <Icon name="map" size={48} style={{ color: '#d1d5db', marginBottom: 16 }} />
          <h3 style={{ fontSize: 18, fontWeight: 600, color: '#374151', marginBottom: 8 }}>
            Aucune destination
          </h3>
          <p style={{ color: '#6b7280', marginBottom: 20 }}>
            Commencez par ajouter des destinations √† votre itin√©raire
          </p>
          <button
            onClick={() => setShowAddModal(true)}
            style={{
              padding: '10px 20px',
              backgroundColor: '#6366f1',
              color: 'white',
              border: 'none',
              borderRadius: 8,
              fontSize: 14,
              fontWeight: 500,
              cursor: 'pointer'
            }}
          >
            + Ajouter ma premi√®re destination
          </button>
        </div>
      ) : (
        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
          {etapes.map((etape, index) => (
            <DestinationCard
              key={etape.id}
              etape={etape}
              index={index}
              onUpdate={(updates) => onUpdateEtape(etape.id, updates)}
              onRemove={() => onRemoveEtape(etape.id)}
              onDragStart={(e) => handleDragStart(e, index)}
              onDragOver={(e) => handleDragOver(e, index)}
              onDragEnd={handleDragEnd}
              isDragging={draggedIndex === index}
              transportTypes={TRANSPORT_TYPES}
            />
          ))}
        </div>
      )}

      {/* Modal Ajouter Destination */}
      {showAddModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }}>
          <div style={{
            backgroundColor: 'white',
            borderRadius: 16,
            width: '90%',
            maxWidth: 700,
            maxHeight: '80vh',
            overflow: 'hidden',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* Header Modal */}
            <div style={{ 
              padding: '20px 24px', 
              borderBottom: '1px solid #e5e7eb',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <h2 style={{ fontSize: 18, fontWeight: 600, margin: 0 }}>
                Ajouter une destination
              </h2>
              <button
                onClick={() => setShowAddModal(false)}
                style={{
                  width: 32,
                  height: 32,
                  borderRadius: 8,
                  border: 'none',
                  backgroundColor: '#f3f4f6',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
              >
                <Icon name="x" size={18} />
              </button>
            </div>

            {/* Filtres pays */}
            <div style={{ padding: '16px 24px', borderBottom: '1px solid #e5e7eb' }}>
              <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                <button
                  onClick={() => setSelectedCountry('all')}
                  style={{
                    padding: '8px 16px',
                    borderRadius: 20,
                    border: 'none',
                    backgroundColor: selectedCountry === 'all' ? '#6366f1' : '#f3f4f6',
                    color: selectedCountry === 'all' ? 'white' : '#374151',
                    fontSize: 13,
                    fontWeight: 500,
                    cursor: 'pointer'
                  }}
                >
                  Tous
                </button>
                {COUNTRIES.map(country => (
                  <button
                    key={country.id}
                    onClick={() => setSelectedCountry(country.id)}
                    style={{
                      padding: '8px 16px',
                      borderRadius: 20,
                      border: 'none',
                      backgroundColor: selectedCountry === country.id ? COUNTRY_COLORS[country.id] : '#f3f4f6',
                      color: selectedCountry === country.id ? 'white' : '#374151',
                      fontSize: 13,
                      fontWeight: 500,
                      cursor: 'pointer'
                    }}
                  >
                    {country.name}
                  </button>
                ))}
              </div>
            </div>

            {/* Liste destinations */}
            <div style={{ flex: 1, overflow: 'auto', padding: 24 }}>
              {availableDestinations.length === 0 ? (
                <p style={{ textAlign: 'center', color: '#6b7280', padding: 40 }}>
                  Toutes les destinations de ce pays ont √©t√© ajout√©es
                </p>
              ) : (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16 }}>
                  {availableDestinations.map(dest => {
                    const countryInfo = getCountryInfo(dest.countryId);
                    const poiCount = getAllPOICount ? getAllPOICount(dest.id) : 0;
                    const preco = PRECONISATIONS[dest.id];

                    return (
                      <button
                        key={dest.id}
                        onClick={() => {
                          onAddEtape(dest.id);
                          setShowAddModal(false);
                        }}
                        style={{
                          padding: 0,
                          backgroundColor: 'white',
                          border: '1px solid #e5e7eb',
                          borderRadius: 12,
                          cursor: 'pointer',
                          textAlign: 'left',
                          overflow: 'hidden',
                          transition: 'all 0.2s'
                        }}
                        onMouseOver={(e) => {
                          e.currentTarget.style.borderColor = '#6366f1';
                          e.currentTarget.style.transform = 'translateY(-2px)';
                          e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                        }}
                        onMouseOut={(e) => {
                          e.currentTarget.style.borderColor = '#e5e7eb';
                          e.currentTarget.style.transform = 'translateY(0)';
                          e.currentTarget.style.boxShadow = 'none';
                        }}
                      >
                        {/* Image */}
                        <div style={{
                          height: 100,
                          backgroundImage: `url(${dest.image})`,
                          backgroundSize: 'cover',
                          backgroundPosition: 'center',
                          position: 'relative'
                        }}>
                          <div style={{
                            position: 'absolute',
                            top: 8,
                            left: 8,
                            padding: '4px 10px',
                            backgroundColor: COUNTRY_COLORS[dest.countryId],
                            color: 'white',
                            borderRadius: 12,
                            fontSize: 11,
                            fontWeight: 600
                          }}>
                            {countryInfo?.name}
                          </div>
                        </div>

                        {/* Infos */}
                        <div style={{ padding: 14 }}>
                          <div style={{ fontWeight: 600, fontSize: 15, color: '#111827', marginBottom: 6 }}>
                            {dest.name}
                          </div>
                          <div style={{ fontSize: 13, color: '#6b7280', marginBottom: 8 }}>
                            {poiCount > 0 ? `${poiCount} lieux √† d√©couvrir` : `${dest.days} jours sugg√©r√©s`}
                          </div>
                          {preco && (
                            <div style={{ 
                              fontSize: 12, 
                              color: '#6366f1',
                              backgroundColor: '#f5f3ff',
                              padding: '6px 10px',
                              borderRadius: 6,
                              display: 'inline-block'
                            }}>
                              üí° {preco.nights} nuits recommand√©es
                            </div>
                          )}
                        </div>
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
