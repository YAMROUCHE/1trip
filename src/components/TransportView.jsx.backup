import React, { useState, useEffect } from 'react';

// ============================================
// ICÔNES SVG SOBRES
// ============================================
const Icons = {
  plane: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M17.8 19.2L16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/>
    </svg>
  ),
  car: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10l-2-4H8L6 10l-2.5 1.1C2.7 11.3 2 12.1 2 13v3c0 .6.4 1 1 1h2"/>
      <circle cx="7" cy="17" r="2"/>
      <circle cx="17" cy="17" r="2"/>
    </svg>
  ),
  bus: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M8 6v6"/><path d="M16 6v6"/><path d="M2 12h20"/>
      <path d="M18 18h2a1 1 0 001-1v-7a6 6 0 00-6-6H9a6 6 0 00-6 6v7a1 1 0 001 1h2"/>
      <circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/>
    </svg>
  ),
  train: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <rect x="4" y="3" width="16" height="16" rx="2"/>
      <path d="M4 11h16"/><path d="M12 3v8"/>
      <path d="M8 19l-2 3"/><path d="M18 22l-2-3"/>
      <circle cx="8" cy="15" r="1"/><circle cx="16" cy="15" r="1"/>
    </svg>
  ),
  map: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/>
      <line x1="9" y1="3" x2="9" y2="18"/><line x1="15" y1="6" x2="15" y2="21"/>
    </svg>
  ),
  calendar: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
      <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
      <line x1="3" y1="10" x2="21" y2="10"/>
    </svg>
  ),
  clock: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
    </svg>
  ),
  euro: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M4 10h12"/><path d="M4 14h12"/>
      <path d="M19 6c-1.5-1.5-3.5-2-6-2-5 0-9 4-9 9s4 9 9 9c2.5 0 4.5-.5 6-2"/>
    </svg>
  ),
  externalLink: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
      <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
    </svg>
  ),
  users: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
      <circle cx="9" cy="7" r="4"/>
      <path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/>
    </svg>
  ),
  arrowRight: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>
    </svg>
  ),
  plus: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
  ),
  edit: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
      <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
    </svg>
  ),
  trash: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <polyline points="3 6 5 6 21 6"/>
      <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
    </svg>
  ),
  x: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
  ),
  route: (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <circle cx="6" cy="19" r="3"/><path d="M9 19h8.5a3.5 3.5 0 000-7h-11a3.5 3.5 0 010-7H15"/>
      <circle cx="18" cy="5" r="3"/>
    </svg>
  )
};

const TransportView = () => {
  const [activeTab, setActiveTab] = useState('itineraire');
  const [flights, setFlights] = useState([]);
  const [localTransport, setLocalTransport] = useState([]);
  const [connections, setConnections] = useState([]);
  const [myTransports, setMyTransports] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedCountry, setSelectedCountry] = useState('all');
  const [showForm, setShowForm] = useState(false);
  const [editingTransport, setEditingTransport] = useState(null);

  const API_URL = 'https://tripflow-api.youssef-amrouche.workers.dev';

  const fetchData = async () => {
    setLoading(true);
    try {
      const [flightsRes, localRes, connRes, myRes] = await Promise.all([
        fetch(`${API_URL}/api/international-flights`),
        fetch(`${API_URL}/api/local-transport`),
        fetch(`${API_URL}/api/transport-connections`),
        fetch(`${API_URL}/api/my-transports`)
      ]);
      
      if (flightsRes.ok) setFlights(await flightsRes.json());
      if (localRes.ok) setLocalTransport(await localRes.json());
      if (connRes.ok) setConnections(await connRes.json());
      if (myRes.ok) setMyTransports(await myRes.json());
    } catch (error) {
      console.error('Erreur chargement transports:', error);
    }
    setLoading(false);
  };

  useEffect(() => { fetchData(); }, []);

  // ============================================
  // ONGLET MON ITINÉRAIRE
  // ============================================
  const MonItineraireTab = () => {
    const [formData, setFormData] = useState({
      trip_day: '',
      date: '',
      from_place: '',
      to_place: '',
      transport_type: 'grab',
      transport_provider: '',
      departure_time: '',
      duration_hours: '',
      cost_eur: '',
      booking_status: 'a_planifier',
      notes: ''
    });

    useEffect(() => {
      if (editingTransport) {
        setFormData({
          trip_day: editingTransport.trip_day || '',
          date: editingTransport.date || '',
          from_place: editingTransport.from_place || '',
          to_place: editingTransport.to_place || '',
          transport_type: editingTransport.transport_type || 'grab',
          transport_provider: editingTransport.transport_provider || '',
          departure_time: editingTransport.departure_time || '',
          duration_hours: editingTransport.duration_hours || '',
          cost_eur: editingTransport.cost_eur || '',
          booking_status: editingTransport.booking_status || 'a_planifier',
          notes: editingTransport.notes || ''
        });
      }
    }, [editingTransport]);

    const handleSubmit = async (e) => {
      e.preventDefault();
      try {
        const url = editingTransport 
          ? `${API_URL}/api/my-transports/${editingTransport.id}`
          : `${API_URL}/api/my-transports`;
        
        const res = await fetch(url, {
          method: editingTransport ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...formData,
            trip_day: formData.trip_day ? parseInt(formData.trip_day) : null,
            duration_hours: formData.duration_hours ? parseFloat(formData.duration_hours) : null,
            cost_eur: formData.cost_eur ? parseFloat(formData.cost_eur) : null
          })
        });
        
        if (res.ok) {
          setShowForm(false);
          setEditingTransport(null);
          setFormData({
            trip_day: '', date: '', from_place: '', to_place: '',
            transport_type: 'grab', transport_provider: '', departure_time: '',
            duration_hours: '', cost_eur: '', booking_status: 'a_planifier', notes: ''
          });
          fetchData();
        }
      } catch (error) {
        console.error('Erreur:', error);
      }
    };

    const handleDelete = async (id) => {
      if (!confirm('Supprimer ce trajet ?')) return;
      try {
        const res = await fetch(`${API_URL}/api/my-transports/${id}`, { method: 'DELETE' });
        if (res.ok) fetchData();
      } catch (error) {
        console.error('Erreur:', error);
      }
    };

    const getStatusStyle = (status) => {
      switch (status) {
        case 'confirme': return { bg: '#dcfce7', color: '#166534', label: 'Confirmé' };
        case 'reserve': return { bg: '#dbeafe', color: '#1e40af', label: 'Réservé' };
        case 'a_reserver': return { bg: '#fef3c7', color: '#92400e', label: 'À réserver' };
        default: return { bg: '#f3f4f6', color: '#374151', label: 'À planifier' };
      }
    };

    const getTypeIcon = (type) => {
      const t = type?.toLowerCase() || '';
      if (t.includes('avion')) return Icons.plane;
      if (t.includes('bus') || t.includes('van')) return Icons.bus;
      if (t.includes('train')) return Icons.train;
      if (t.includes('ferry') || t.includes('bateau')) return Icons.map;
      return Icons.car;
    };

    // Grouper par jour
    const groupedByDay = myTransports.reduce((acc, t) => {
      const day = t.trip_day || 0;
      if (!acc[day]) acc[day] = [];
      acc[day].push(t);
      return acc;
    }, {});

    const sortedDays = Object.keys(groupedByDay).map(Number).sort((a, b) => a - b);

    // Calcul du coût total
    const totalCost = myTransports.reduce((sum, t) => sum + (t.cost_eur || 0), 0);

    return (
      <div style={{ padding: '20px' }}>
        {/* Header */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
            <div style={{ color: '#14B8A6' }}>{Icons.route}</div>
            <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>Mon itinéraire transport</h2>
            <span style={{ background: '#f0fdfa', color: '#0d9488', padding: '4px 12px', borderRadius: '12px', fontSize: '14px' }}>
              {myTransports.length} trajets
            </span>
            <span style={{ background: '#fef3c7', color: '#92400e', padding: '4px 12px', borderRadius: '12px', fontSize: '14px' }}>
              {totalCost}€ estimé
            </span>
          </div>
          <button
            onClick={() => { setShowForm(true); setEditingTransport(null); }}
            style={{
              display: 'flex', alignItems: 'center', gap: '8px',
              background: '#14B8A6', color: 'white', border: 'none',
              padding: '10px 20px', borderRadius: '8px', cursor: 'pointer',
              fontSize: '14px', fontWeight: '500'
            }}
          >
            {Icons.plus} Ajouter un trajet
          </button>
        </div>

        {/* Formulaire */}
        {showForm && (
          <div style={{
            background: 'white', border: '1px solid #e5e7eb', borderRadius: '12px',
            padding: '24px', marginBottom: '24px', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h3 style={{ margin: 0, fontSize: '18px' }}>
                {editingTransport ? 'Modifier le trajet' : 'Nouveau trajet'}
              </h3>
              <button onClick={() => { setShowForm(false); setEditingTransport(null); }}
                style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#6b7280' }}>
                {Icons.x}
              </button>
            </div>
            
            <form onSubmit={handleSubmit}>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '16px' }}>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Jour du voyage</label>
                  <input type="number" min="1" max="86" value={formData.trip_day}
                    onChange={(e) => setFormData({...formData, trip_day: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}
                    placeholder="Ex: 1"
                  />
                </div>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Date</label>
                  <input type="date" value={formData.date}
                    onChange={(e) => setFormData({...formData, date: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}
                  />
                </div>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Heure départ</label>
                  <input type="time" value={formData.departure_time}
                    onChange={(e) => setFormData({...formData, departure_time: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}
                  />
                </div>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px', marginBottom: '16px' }}>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Départ *</label>
                  <input type="text" value={formData.from_place} required
                    onChange={(e) => setFormData({...formData, from_place: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}
                    placeholder="Ex: Hôtel Makati"
                  />
                </div>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Arrivée *</label>
                  <input type="text" value={formData.to_place} required
                    onChange={(e) => setFormData({...formData, to_place: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}
                    placeholder="Ex: Aéroport MNL"
                  />
                </div>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '16px' }}>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Type *</label>
                  <select value={formData.transport_type} required
                    onChange={(e) => setFormData({...formData, transport_type: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}>
                    <option value="avion">Avion</option>
                    <option value="grab">Grab / Taxi</option>
                    <option value="bus">Bus</option>
                    <option value="van">Van</option>
                    <option value="ferry">Ferry</option>
                    <option value="train">Train</option>
                    <option value="navette">Navette</option>
                    <option value="scooter">Scooter</option>
                    <option value="marche">À pied</option>
                  </select>
                </div>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Prestataire</label>
                  <input type="text" value={formData.transport_provider}
                    onChange={(e) => setFormData({...formData, transport_provider: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}
                    placeholder="Ex: AirSwift, Grab Car"
                  />
                </div>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Durée (h)</label>
                  <input type="number" step="0.5" value={formData.duration_hours}
                    onChange={(e) => setFormData({...formData, duration_hours: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}
                    placeholder="Ex: 1.5"
                  />
                </div>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Coût (€)</label>
                  <input type="number" step="0.01" value={formData.cost_eur}
                    onChange={(e) => setFormData({...formData, cost_eur: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}
                    placeholder="Ex: 15"
                  />
                </div>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '16px', marginBottom: '20px' }}>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Statut</label>
                  <select value={formData.booking_status}
                    onChange={(e) => setFormData({...formData, booking_status: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}>
                    <option value="a_planifier">À planifier</option>
                    <option value="a_reserver">À réserver</option>
                    <option value="reserve">Réservé</option>
                    <option value="confirme">Confirmé</option>
                  </select>
                </div>
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500' }}>Notes</label>
                  <input type="text" value={formData.notes}
                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                    style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px' }}
                    placeholder="Ex: Réserver la veille"
                  />
                </div>
              </div>

              <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                <button type="button" onClick={() => { setShowForm(false); setEditingTransport(null); }}
                  style={{ padding: '10px 20px', borderRadius: '8px', border: '1px solid #d1d5db', background: 'white', cursor: 'pointer', fontSize: '14px' }}>
                  Annuler
                </button>
                <button type="submit"
                  style={{ padding: '10px 20px', borderRadius: '8px', border: 'none', background: '#14B8A6', color: 'white', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>
                  {editingTransport ? 'Modifier' : 'Ajouter'}
                </button>
              </div>
            </form>
          </div>
        )}

        {/* Liste des trajets groupés par jour */}
        {sortedDays.map(day => (
          <div key={day} style={{ marginBottom: '24px' }}>
            <div style={{
              display: 'flex', alignItems: 'center', gap: '12px',
              padding: '12px 16px', background: '#f8fafc', borderRadius: '8px', marginBottom: '12px'
            }}>
              {Icons.calendar}
              <span style={{ fontWeight: '600', fontSize: '16px' }}>
                {day === 0 ? 'Non planifié' : `Jour ${day}`}
              </span>
              {groupedByDay[day][0]?.date && (
                <span style={{ color: '#6b7280', fontSize: '14px' }}>
                  - {new Date(groupedByDay[day][0].date).toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' })}
                </span>
              )}
            </div>

            {groupedByDay[day].map((transport) => {
              const status = getStatusStyle(transport.booking_status);
              return (
                <div key={transport.id} style={{
                  background: 'white', border: '1px solid #e5e7eb', borderRadius: '10px',
                  padding: '16px', marginBottom: '8px', marginLeft: '20px',
                  display: 'flex', alignItems: 'center', gap: '16px'
                }}>
                  <div style={{ color: '#14B8A6', background: '#f0fdfa', padding: '10px', borderRadius: '8px' }}>
                    {getTypeIcon(transport.transport_type)}
                  </div>

                  <div style={{ flex: 1 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                      {transport.departure_time && (
                        <span style={{ fontWeight: '600', color: '#14B8A6' }}>{transport.departure_time}</span>
                      )}
                      <span style={{ fontWeight: '500' }}>{transport.from_place}</span>
                      <span style={{ color: '#9ca3af' }}>{Icons.arrowRight}</span>
                      <span style={{ fontWeight: '500' }}>{transport.to_place}</span>
                    </div>
                    <div style={{ fontSize: '13px', color: '#6b7280', display: 'flex', gap: '16px' }}>
                      <span style={{ textTransform: 'capitalize' }}>{transport.transport_type}</span>
                      {transport.transport_provider && <span>{transport.transport_provider}</span>}
                      {transport.notes && <span style={{ fontStyle: 'italic' }}>{transport.notes}</span>}
                    </div>
                  </div>

                  <div style={{ textAlign: 'right', minWidth: '80px' }}>
                    {transport.duration_hours && (
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px', justifyContent: 'flex-end', marginBottom: '4px' }}>
                        {Icons.clock} {transport.duration_hours}h
                      </div>
                    )}
                    {transport.cost_eur > 0 && (
                      <div style={{ color: '#14B8A6', fontWeight: '500' }}>{transport.cost_eur}€</div>
                    )}
                  </div>

                  <span style={{
                    background: status.bg, color: status.color,
                    padding: '4px 10px', borderRadius: '6px', fontSize: '12px', fontWeight: '500'
                  }}>
                    {status.label}
                  </span>

                  <div style={{ display: 'flex', gap: '8px' }}>
                    <button onClick={() => { setEditingTransport(transport); setShowForm(true); }}
                      style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#6b7280', padding: '4px' }}>
                      {Icons.edit}
                    </button>
                    <button onClick={() => handleDelete(transport.id)}
                      style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#ef4444', padding: '4px' }}>
                      {Icons.trash}
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        ))}

        {myTransports.length === 0 && !loading && (
          <div style={{ textAlign: 'center', padding: '60px', color: '#9ca3af' }}>
            <div style={{ marginBottom: '16px' }}>{Icons.route}</div>
            <p>Aucun trajet planifié.</p>
            <button onClick={() => setShowForm(true)}
              style={{ marginTop: '12px', padding: '10px 20px', background: '#14B8A6', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer' }}>
              Ajouter mon premier trajet
            </button>
          </div>
        )}
      </div>
    );
  };

  // ============================================
  // ONGLET VOLS
  // ============================================
  const VolsTab = () => {
    const getStatusStyle = (status) => {
      switch (status) {
        case 'reserve': return { bg: '#dcfce7', color: '#166534', label: 'Réservé' };
        case 'a_reserver': return { bg: '#fef3c7', color: '#92400e', label: 'À réserver' };
        case 'a_planifier': return { bg: '#e0e7ff', color: '#3730a3', label: 'À planifier' };
        default: return { bg: '#f3f4f6', color: '#374151', label: status };
      }
    };
    const formatDate = (dateStr) => {
      if (!dateStr) return 'Date à définir';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
    };
    return (
      <div style={{ padding: '20px' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '24px' }}>
          <div style={{ color: '#14B8A6' }}>{Icons.plane}</div>
          <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>Vols internationaux</h2>
          <span style={{ background: '#f0fdfa', color: '#0d9488', padding: '4px 12px', borderRadius: '12px', fontSize: '14px' }}>{flights.length} vols</span>
        </div>
        <div style={{ position: 'relative', paddingLeft: '30px' }}>
          <div style={{ position: 'absolute', left: '9px', top: '20px', bottom: '20px', width: '2px', background: '#e5e7eb' }} />
          {flights.map((flight, index) => {
            const status = getStatusStyle(flight.booking_status);
            return (
              <div key={flight.id} style={{ position: 'relative', marginBottom: '24px', paddingBottom: '24px', borderBottom: index < flights.length - 1 ? '1px solid #f3f4f6' : 'none' }}>
                <div style={{ position: 'absolute', left: '-25px', top: '4px', width: '12px', height: '12px', borderRadius: '50%', background: flight.booking_status === 'reserve' ? '#10b981' : flight.booking_status === 'a_reserver' ? '#f59e0b' : '#6366f1', border: '2px solid white', boxShadow: '0 0 0 2px #e5e7eb' }} />
                <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: '12px', padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.05)' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>{Icons.calendar}<span style={{ fontWeight: '500' }}>{formatDate(flight.departure_date)}</span></div>
                    <span style={{ background: status.bg, color: status.color, padding: '4px 10px', borderRadius: '6px', fontSize: '12px', fontWeight: '500' }}>{status.label}</span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' }}>
                    <div style={{ textAlign: 'center', flex: 1 }}>
                      <div style={{ fontSize: '24px', fontWeight: '700', color: '#111827' }}>{flight.from_airport_code}</div>
                      <div style={{ fontSize: '14px', color: '#6b7280' }}>{flight.from_city}</div>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', color: '#14B8A6', flex: 1 }}>
                      <div style={{ color: '#9ca3af', marginBottom: '4px' }}>{Icons.arrowRight}</div>
                      {flight.duration_hours && <span style={{ fontSize: '12px', color: '#9ca3af' }}>{flight.duration_hours}h</span>}
                    </div>
                    <div style={{ textAlign: 'center', flex: 1 }}>
                      <div style={{ fontSize: '24px', fontWeight: '700', color: '#111827' }}>{flight.to_airport_code}</div>
                      <div style={{ fontSize: '14px', color: '#6b7280' }}>{flight.to_city}</div>
                    </div>
                  </div>
                  <div style={{ display: 'flex', gap: '16px', paddingTop: '12px', borderTop: '1px solid #f3f4f6', fontSize: '13px', color: '#6b7280' }}>
                    {flight.airline && <span>{flight.airline}</span>}
                    {flight.price_eur && <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>{Icons.euro} {flight.price_eur}€</span>}
                    {flight.notes && <span style={{ fontStyle: 'italic' }}>{flight.notes}</span>}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
        {flights.length === 0 && !loading && <div style={{ textAlign: 'center', padding: '40px', color: '#9ca3af' }}>Aucun vol enregistré.</div>}
      </div>
    );
  };

  // ============================================
  // ONGLET TRANSFERTS
  // ============================================
  const TransfertsTab = () => {
    const countries = [
      { id: 'all', label: 'Tous les pays' },
      { id: 'philippines', label: 'Philippines' },
      { id: 'thailande', label: 'Thaïlande' },
      { id: 'vietnam', label: 'Vietnam' },
      { id: 'bali', label: 'Bali' }
    ];
    const filteredTransport = selectedCountry === 'all' ? localTransport : localTransport.filter(t => t.country === selectedCountry);
    const familyFriendly = filteredTransport.filter(t => t.family_friendly);
    const soloOnly = filteredTransport.filter(t => !t.family_friendly);
    const getTransportIcon = (type) => {
      switch (type) {
        case 'voiture': case 'taxi': return Icons.car;
        case 'moto': return Icons.bus;
        case 'metro': case 'train': return Icons.train;
        default: return Icons.bus;
      }
    };
    const TransportCard = ({ transport }) => (
      <div style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: '10px', padding: '16px', marginBottom: '12px' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
            <div style={{ color: '#14B8A6', background: '#f0fdfa', padding: '8px', borderRadius: '8px' }}>{getTransportIcon(transport.transport_type)}</div>
            <div>
              <div style={{ fontWeight: '600', fontSize: '15px' }}>{transport.app_name}</div>
              <div style={{ fontSize: '13px', color: '#6b7280' }}>{transport.transport_type}</div>
            </div>
          </div>
          {transport.family_friendly ? (
            <span style={{ display: 'flex', alignItems: 'center', gap: '4px', background: '#dcfce7', color: '#166534', padding: '4px 8px', borderRadius: '6px', fontSize: '12px' }}>{Icons.users} Famille OK</span>
          ) : (
            <span style={{ background: '#fef3c7', color: '#92400e', padding: '4px 8px', borderRadius: '6px', fontSize: '12px' }}>Solo</span>
          )}
        </div>
        <div style={{ display: 'flex', gap: '16px', marginBottom: '12px', fontSize: '14px' }}>
          {transport.base_fare_eur && <div><span style={{ color: '#6b7280' }}>Base: </span><span style={{ fontWeight: '500' }}>{transport.base_fare_eur}€</span></div>}
          {transport.price_per_km_eur && <div><span style={{ color: '#6b7280' }}>Par km: </span><span style={{ fontWeight: '500' }}>{transport.price_per_km_eur}€</span></div>}
          {transport.availability && <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>{Icons.clock}<span>{transport.availability}</span></div>}
        </div>
        {transport.notes && <div style={{ fontSize: '13px', color: '#6b7280', fontStyle: 'italic', marginBottom: '12px' }}>{transport.notes}</div>}
        {transport.app_url && (
          <a href={transport.app_url} target="_blank" rel="noopener noreferrer" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: '#14B8A6', color: 'white', padding: '8px 16px', borderRadius: '8px', textDecoration: 'none', fontSize: '14px', fontWeight: '500' }}>
            Ouvrir {transport.app_name} {Icons.externalLink}
          </a>
        )}
      </div>
    );
    return (
      <div style={{ padding: '20px' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '24px' }}>
          <div style={{ color: '#14B8A6' }}>{Icons.car}</div>
          <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>Transferts et taxis</h2>
        </div>
        <div style={{ display: 'flex', gap: '8px', marginBottom: '24px', flexWrap: 'wrap' }}>
          {countries.map(country => (
            <button key={country.id} onClick={() => setSelectedCountry(country.id)} style={{ padding: '8px 16px', borderRadius: '20px', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', background: selectedCountry === country.id ? '#14B8A6' : '#f3f4f6', color: selectedCountry === country.id ? 'white' : '#374151', transition: 'all 0.2s' }}>
              {country.label}
            </button>
          ))}
        </div>
        {familyFriendly.length > 0 && (
          <div style={{ marginBottom: '32px' }}>
            <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>{Icons.users} Adaptés pour la famille ({familyFriendly.length})</h3>
            {familyFriendly.map(t => <TransportCard key={t.id} transport={t} />)}
          </div>
        )}
        {soloOnly.length > 0 && (
          <div>
            <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px', color: '#6b7280' }}>Solo uniquement ({soloOnly.length})</h3>
            {soloOnly.map(t => <TransportCard key={t.id} transport={t} />)}
          </div>
        )}
        {filteredTransport.length === 0 && !loading && <div style={{ textAlign: 'center', padding: '40px', color: '#9ca3af' }}>Aucun transport trouvé pour ce pays.</div>}
      </div>
    );
  };

  // ============================================
  // ONGLET CONNEXIONS
  // ============================================
  const QuotidienTab = () => {
    const [selectedFrom, setSelectedFrom] = useState('');
    const destinations = [...new Set([...connections.map(c => c.from_destination), ...connections.map(c => c.to_destination)])].sort();
    const filteredConnections = selectedFrom ? connections.filter(c => c.from_destination === selectedFrom) : connections.slice(0, 20);
    const getTypeIcon = (type) => {
      const t = type?.toLowerCase() || '';
      if (t.includes('avion')) return Icons.plane;
      if (t.includes('bus') || t.includes('van')) return Icons.bus;
      if (t.includes('train')) return Icons.train;
      if (t.includes('ferry') || t.includes('bateau')) return Icons.map;
      return Icons.car;
    };
    return (
      <div style={{ padding: '20px' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '24px' }}>
          <div style={{ color: '#14B8A6' }}>{Icons.map}</div>
          <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>Connexions inter-destinations</h2>
          <span style={{ background: '#f0fdfa', color: '#0d9488', padding: '4px 12px', borderRadius: '12px', fontSize: '14px' }}>{connections.length} trajets</span>
        </div>
        <div style={{ marginBottom: '24px' }}>
          <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500' }}>Filtrer par point de départ :</label>
          <select value={selectedFrom} onChange={(e) => setSelectedFrom(e.target.value)} style={{ padding: '10px 16px', borderRadius: '8px', border: '1px solid #d1d5db', fontSize: '14px', minWidth: '250px', cursor: 'pointer' }}>
            <option value="">-- Toutes les destinations --</option>
            {destinations.map(dest => <option key={dest} value={dest}>{dest.charAt(0).toUpperCase() + dest.slice(1).replace(/-/g, ' ')}</option>)}
          </select>
        </div>
        <div style={{ display: 'grid', gap: '12px' }}>
          {filteredConnections.map((conn, index) => (
            <div key={conn.id || index} style={{ background: 'white', border: '1px solid #e5e7eb', borderRadius: '10px', padding: '16px', display: 'flex', alignItems: 'center', gap: '16px' }}>
              <div style={{ color: '#14B8A6', background: '#f0fdfa', padding: '10px', borderRadius: '8px' }}>{getTypeIcon(conn.transport_type)}</div>
              <div style={{ flex: 1 }}>
                <div style={{ fontWeight: '600', marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ textTransform: 'capitalize' }}>{conn.from_destination?.replace(/-/g, ' ')}</span>
                  <span style={{ color: '#9ca3af' }}>{Icons.arrowRight}</span>
                  <span style={{ textTransform: 'capitalize' }}>{conn.to_destination?.replace(/-/g, ' ')}</span>
                </div>
                <div style={{ fontSize: '13px', color: '#6b7280', display: 'flex', gap: '16px' }}>
                  <span style={{ textTransform: 'capitalize' }}>{conn.transport_type}</span>
                  {conn.company && <span>{conn.company}</span>}
                </div>
              </div>
              <div style={{ textAlign: 'right' }}>
                {conn.duration_hours && <div style={{ fontWeight: '600', display: 'flex', alignItems: 'center', gap: '4px', justifyContent: 'flex-end' }}>{Icons.clock} {conn.duration_hours}h</div>}
                {conn.estimated_cost_eur && <div style={{ color: '#14B8A6', fontSize: '14px', fontWeight: '500' }}>{conn.estimated_cost_eur}€</div>}
              </div>
            </div>
          ))}
        </div>
        {filteredConnections.length === 0 && !loading && <div style={{ textAlign: 'center', padding: '40px', color: '#9ca3af' }}>Aucune connexion trouvée.</div>}
        {!selectedFrom && connections.length > 20 && <div style={{ textAlign: 'center', padding: '20px', color: '#6b7280', fontSize: '14px' }}>Affichage des 20 premières. Sélectionnez un point de départ pour filtrer.</div>}
      </div>
    );
  };

  // ============================================
  // RENDU PRINCIPAL
  // ============================================
  return (
    <div style={{ height: '100%', display: 'flex', flexDirection: 'column', background: '#f9fafb' }}>
      <div style={{ background: 'white', borderBottom: '1px solid #e5e7eb', padding: '0 20px' }}>
        <div style={{ display: 'flex', gap: '4px', paddingTop: '16px' }}>
          {[
            { id: 'itineraire', label: 'Mon itinéraire', icon: Icons.route },
            { id: 'vols', label: 'Vols', icon: Icons.plane },
            { id: 'transferts', label: 'Transferts', icon: Icons.car },
            { id: 'connexions', label: 'Connexions', icon: Icons.map }
          ].map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '12px 20px', border: 'none', borderBottom: activeTab === tab.id ? '2px solid #14B8A6' : '2px solid transparent', background: 'transparent', color: activeTab === tab.id ? '#14B8A6' : '#6b7280', fontWeight: activeTab === tab.id ? '600' : '400', cursor: 'pointer', transition: 'all 0.2s', fontSize: '15px' }}>
              {tab.icon}
              {tab.label}
            </button>
          ))}
        </div>
      </div>
      <div style={{ flex: 1, overflow: 'auto' }}>
        {loading ? (
          <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '200px', color: '#9ca3af' }}>Chargement...</div>
        ) : (
          <>
            {activeTab === 'itineraire' && <MonItineraireTab />}
            {activeTab === 'vols' && <VolsTab />}
            {activeTab === 'transferts' && <TransfertsTab />}
            {activeTab === 'connexions' && <QuotidienTab />}
          </>
        )}
      </div>
    </div>
  );
};

export default TransportView;
